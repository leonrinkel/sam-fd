/* SPDX-License-Identifier: MIT */
/**
 * \file      src/main.c
 * \brief     Main application logic
 * \copyright Copyright (c) 2023 Leon Rinkel
 */

#include <stdbool.h>

#include <drv/can.h>
#include <drv/flash.h>
#include <drv/uart.h>

#include <reg/can.h>
#include <reg/dsu.h>
#include <reg/port.h>

#include <main.h>

static const uint8_t some_data[256] =
{
	0xABu, 0x14u, 0xF8u, 0xC8u, 0x04u, 0x8Eu, 0xF1u, 0xEFu, 0xD2u, 0x05u, 0xD3u, 0x49u, 0x81u, 0x5Bu, 0xDEu, 0x75u,
	0x97u, 0x17u, 0x9Bu, 0xAEu, 0x33u, 0x2Bu, 0x0Bu, 0x5Eu, 0xFCu, 0x37u, 0x68u, 0x8Cu, 0x06u, 0x4Cu, 0xE6u, 0x04u,
	0x14u, 0x76u, 0x63u, 0x5Cu, 0x40u, 0x8Du, 0xA7u, 0x9Au, 0xC0u, 0xB7u, 0xB0u, 0xDFu, 0xE4u, 0x50u, 0xE8u, 0x01u,
	0x4Du, 0x2Bu, 0xE9u, 0x7Cu, 0xFEu, 0x3Bu, 0xCEu, 0x68u, 0xAAu, 0xB5u, 0x53u, 0x67u, 0x26u, 0x59u, 0x3Bu, 0x39u,
	0x8Cu, 0xACu, 0x42u, 0x5Eu, 0x97u, 0x51u, 0x9Du, 0x50u, 0xFCu, 0x77u, 0xDEu, 0x0Cu, 0x0Au, 0x4Bu, 0x68u, 0x63u,
	0xCFu, 0x58u, 0x59u, 0x75u, 0xEEu, 0x17u, 0x31u, 0x78u, 0xBAu, 0x22u, 0xFCu, 0xA1u, 0xE0u, 0xC9u, 0x6Du, 0x47u,
	0x8Bu, 0x14u, 0x7Au, 0xD5u, 0x05u, 0xA4u, 0x9Bu, 0xCEu, 0xCBu, 0x95u, 0x78u, 0x76u, 0xC7u, 0x97u, 0x6Bu, 0x5Fu,
	0x77u, 0x21u, 0x1Au, 0xEDu, 0x6Eu, 0xEFu, 0xCDu, 0xDAu, 0x36u, 0x72u, 0x3Cu, 0xCAu, 0x6Cu, 0xBFu, 0x4Cu, 0xA5u,
	0x93u, 0x82u, 0xFCu, 0x61u, 0x21u, 0x16u, 0xA7u, 0x30u, 0x86u, 0x86u, 0xBBu, 0x57u, 0xF7u, 0x00u, 0x0Bu, 0xB1u,
	0x91u, 0xA6u, 0xBAu, 0x8Fu, 0x6Au, 0xFFu, 0xFDu, 0xD9u, 0x88u, 0x93u, 0x97u, 0x13u, 0x1Fu, 0x28u, 0x2Bu, 0xC6u,
	0x05u, 0xB3u, 0x3Fu, 0x4Du, 0x44u, 0xDBu, 0xABu, 0x8Du, 0xDFu, 0xDDu, 0x71u, 0x6Du, 0x81u, 0x1Cu, 0x04u, 0x00u,
	0x0Cu, 0x58u, 0x60u, 0x7Cu, 0xBEu, 0x51u, 0x9Du, 0x7Cu, 0x7Cu, 0xC7u, 0x3Au, 0x7Cu, 0xDEu, 0x15u, 0x88u, 0x3Du,
	0xC1u, 0x74u, 0x5Au, 0xE5u, 0x3Eu, 0x25u, 0xD7u, 0x30u, 0xC5u, 0xEFu, 0xD1u, 0x96u, 0x14u, 0xB6u, 0x23u, 0x8Cu,
	0xE5u, 0x68u, 0xB9u, 0x81u, 0xB3u, 0x67u, 0x76u, 0x65u, 0xB8u, 0x31u, 0xDFu, 0x84u, 0x5Fu, 0x30u, 0x85u, 0x37u,
	0xB6u, 0xD6u, 0x56u, 0x31u, 0x62u, 0xFAu, 0x73u, 0x20u, 0x4Fu, 0x39u, 0x22u, 0xC5u, 0xCEu, 0xE7u, 0x84u, 0x7Bu,
	0x82u, 0x27u, 0xA9u, 0xC4u, 0x5Cu, 0x06u, 0x44u, 0xA1u, 0x59u, 0x2Au, 0x70u, 0xE5u, 0x25u, 0xB9u, 0x6Fu, 0x40u,
};

/** \brief Main function */
int main(void)
{
	while (true)
	{
		__asm__("nop");
	}

	return 0;
}

void task_1ms(void)
{
	uint8_t cmd[2];
	uint32_t crc;

	if (uart_available() == 2)
	{
		if (uart_read(cmd, 2) != 2)
		{
			return;
		}

		if (cmd[0] == 'u' && cmd[1] == 'a')
		{
			uart_write((uint8_t*) " pressed a ", 12);
		}
		else if (cmd[0] == 'f' && cmd[1] == 'e')
		{
			/* Test erasing flash */
			if (flash_erase_row(0xF00u))
			{
				uart_write((uint8_t*) " ok ", 5);
			}
			else
			{
				uart_write((uint8_t*) " nok ", 6);
			}
		}
		else if (cmd[0] == 'f' && cmd[1] == 'w')
		{
			/* Test writing flash */
			if (flash_write_row(0xF00u, some_data))
			{
				uart_write((uint8_t*) " ok ", 5);
			}
			else
			{
				uart_write((uint8_t*) " nok ", 6);
			}
		}
		else if (cmd[0] == 'h' && cmd[1] == 'c')
		{
			/* Test hardware accelerated CRC */

			/* Start CRC calculation */
			DSU_ADDR.U =
				(uint32_t) some_data |
				(0x0u << DSU_ADDR_AMOD_OFF);
			DSU_LENGTH.U = 256u;
			DSU_DATA = 0xFFFFFFFFu; /* Initial value */
			DSU_CTRL.U = DSU_CTRL_CRC_MSK;

			/* Wait till CRC finished */
			while (!DSU_STATUSA.B.DONE);
			DSU_STATUSA.U = DSU_STATUSA_DONE_MSK;

			crc = DSU_DATA ^ 0xFFFFFFFFu; /* Final XOR value */
			if (crc == 0x8E663A3Du)
			{
				uart_write((uint8_t*) " ok ", 5);
			}
			else
			{
				uart_write((uint8_t*) " nok ", 6);
			}
		}
	}
}

void task_10ms(void)
{
	/* UART transmit */
	uart_write((uint8_t*) "yo", 2);
}

void task_100ms(void)
{
	static uint8_t cycle = 0;

	if (PORT_IN.B.IN8)
	{
		/* Toggle TX_ACT/RX_ACT LEDs */
		PORT_OUT.U ^= PORT_DIR_DIR9_MSK;
		PORT_OUT.U ^= PORT_DIR_DIR10_MSK;
	}

	/* Fill CAN TX buffer 0 */
	can_tx_buffer[0].U[0] =
		(0x123u << CAN_TX_BUFFER_STD_ID_OFF);
	can_tx_buffer[0].U[1] =
		(0x3u << CAN_TX_BUFFER_DLC_OFF);
	can_tx_buffer[0].B.DB[0] = cycle;
	can_tx_buffer[0].B.DB[1] = cycle;
	can_tx_buffer[0].B.DB[2] = cycle++;

	/* Transmit message */
	CAN0_TXBAR = 0x1u << 0;
}

void task_1000ms(void)
{
	if (!PORT_IN.B.IN8)
	{
		/* Toggle TX_ACT/RX_ACT LEDs */
		PORT_OUT.U ^= PORT_DIR_DIR9_MSK;
		PORT_OUT.U ^= PORT_DIR_DIR10_MSK;
	}

	/* UART transmit */
	uart_write((uint8_t*) " hello ", 8);
}
